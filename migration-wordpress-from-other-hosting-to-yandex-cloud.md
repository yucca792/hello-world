---
title: "Wordpress и LAMP. Как перенести веб-сайта Wordpress с другого хостинга на LAMP-стек Yandex.Cloud без изменения доменного имени веб-сайта. Инструкция"
description: "Пошаговая инструкция, с помощью которой вы научитесь вы научитесь разворачивать LAMP в инфраструктуре Yandex.Cloud, настраивать веб-сервер для доступа по протоколу HTTPS с использованием SSL сертификата от Let's Encrypt, переносить данные и настройки Wordpress, переводить Wordpress на протокол HTTPS."
---

# Перенос веб-сайта Wordpress с другого хостинга на LAMP-стек Yandex.Cloud без изменения доменного имени веб-сайта.
[Wordpress](https://wordpress.com/ru/) - популярная CMS для создания и управления веб-сайтами.

[LAMP](https://ru.wikipedia.org/wiki/LAMP) ([Linux](https://www.linux.org/), [Apache HTTP Server](https://httpd.apache.org/), [MySQL](https://www.mysql.com/), [PHP](https://www.php.net/)) — популярный набор компонентов для развертывания веб-приложений и динамических сайтов.

С помощью этой инструкции вы научитесь разворачивать **LAMP** в инфраструктуре {{ yandex-cloud }}, настраивать веб-сервер для доступа по протоколу **HTTPS** с использованием SSL сертификата от Let's Encrypt, переносить данные и настройки **Wordpress**, переводить **Wordpress** на протокол **HTTPS**."

Чтобы развернуть платформу **LAMP**, настроить веб-сервер для доступа по **HTTPS**, перенести данные и настроить **Wordpress**:
1. [Подготовьте облако к работе](#before-you-begin).
2. [Создайте виртуальную машину с предустановленным веб-сервером](#create-vm-lamp).
3. [Проверьте работу сайта по внешнему IP-адресу](#test-site-ext-address).
4. [Настройте виртуальный хост для вашего домена](#configure-virthost-http).
5. [Настройте сетевой экран ВМ](#configure-ufw).
6. [Настройте DNS](#configure-dns).
7. [Проверьте работу сайта по доменному имени](#test-site-cname).
8. [Создайте **SSL** cертификат Let’s Encrypt для **Apache**](#create-ssl-le-http-apache).
9. [Настройте доступ к веб-сайту по протоколу **HTTPS**](#configure-access-https-apache).
10. [Настройте автоматическое обновление сертификата](#configure-le-renew).
11. [Настройте расширенные настройки безопасности **Apache**](#configure-advanced-security-apache).
12. [Настройте переадресацию (редирект) запросов по **HTTP**](#configure-redirect-https-apache).
13. [Установите дополнительные пакеты php для **Wordpress**](#install-add-php-for-wordpress}).
14. [Подготовьте резервную копию базы данных **Wordpress**](#create-dump-mysql-migration-wordpress).
15. [Подготовьте архив всех файлов **Wordpress**](#create-arсhive-all-files-migration-wordpress).
16. [Загрузите резервную копию базы данных **Wordpress** с компьютера в домашний каталог](#upload-dump-from-pc-to-home-catalog).
17. [Загрузите файлы **Wordpress** с компьютера в корневой каталог](#upload-files-from-pc-to-documentroot).
18. [Настройте права доступа к каталогам и файлам сайта-приемника](#configure-access-rights-apache).
19. [Восстановите базу данных **Wordpress** из резервной копии](#recovery-database-wordpress-from-dump).
20. [Настройте **Wordpress** для работы в защищенном режиме](#configure-wordpress-https).
21. [Настройте веб-сайт **Wordpress** для правильной индексации по **HTTPS**](#configure-wordpress-sitemap-robot-https).
22. [Выполните переезд сайта с **HTTP** на **HTTPS** в **Google Search Console**](#migration-hhtp-https-google).
23. [Выполните переезд сайта с **HTTP** на **HTTPS** в **Яндекс.Вебмастер**](#migration-hhtp-https-yandex).
24. [Как удалить созданные ресурсы](#clear-out)

Если сайт вам больше не нужен, [удалите все используемые им ресурсы](#clear-out).

## Подготовьте облако к работе {#before-you-begin}

Перед тем, как разворачивать сервер, нужно зарегистрироваться в {{ yandex-cloud }} и создать платежный аккаунт:

{% include [prepare-register-billing](../../_includes/solutions/_common/prepare-register-billing.md) %}

Если у вас есть активный платежный аккаунт, вы можете создать или выбрать каталог, в котором будет работать ваша ВМ, на [странице облака](https://console.cloud.yandex.ru/cloud).

[Подробнее об облаках и каталогах](../../resource-manager/concepts/resources-hierarchy.md).

### Необходимые платные ресурсы {#paid-resources}

В стоимость поддержки LAMP-сервера входит:
* плата за постоянно запущенную ВМ (см. [тарифы {{ compute-full-name }}](../../compute/pricing.md));
* плата за использование динамического или статического внешнего IP-адреса (см. [тарифы {{ vpc-full-name }}](../../vpc/pricing.md)).

## Создайте виртуальную машину с предустановленным веб-сервером {#create-vm-lamp}

1. На странице каталога в [консоли управления]({{ link-console-main }}) нажмите кнопку **Создать ресурс** и выберите пункт **Виртуальная машина**.
1. В поле **Имя** введите имя ВМ — `lamp-vm`.

   {% include [name-format](../../_includes/name-format.md) %}

1. Выберите [зону доступности](../../overview/concepts/geo-scope.md), в которой должна находиться ВМ. Если вы не знаете, какая зона доступности вам нужна, оставьте выбранную по умолчанию.
1. В блоке **Образы из {{ marketplace-name }}** нажмите кнопку **Выбрать** и выберите образ ВМ с нужным набором компонентов:
   * **LAMP** для Linux, Apache, MySQL, PHP.
  
1. В блоке **Вычислительные ресурсы**:
   * Выберите [платформу](../../compute/concepts/vm-platforms.md) ВМ.
   * Укажите нужное количество vCPU и объем RAM.

   Для функционального тестирования сайта хватит минимальной конфигурации:
   * **Платформа** — Intel Ice Lake.
   * **Гарантированная доля vCPU** — 20%.
   * **vCPU** — 2.
   * **RAM** — 1 ГБ.
1. В блоке **Сетевые настройки** нужно выбрать сеть и подсеть, к которым нужно подключить ВМ. Если нужной сети или подсети еще нет, вы можете создать их прямо на странице создания ВМ.
1. В поле **Публичный адрес** оставьте значение **Автоматически**, чтобы назначить ВМ случайный внешний IP-адрес из пула {{ yandex-cloud }}, или выберите статический адрес из списка, если вы зарезервировали его заранее.
1. Укажите данные для доступа на ВМ:
   * В поле **Логин** введите имя пользователя.
   * В поле **SSH-ключ** вставьте содержимое файла открытого ключа.

     Пару ключей для подключения по SSH нужно создать самостоятельно, см. раздел [{#T}](../../compute/operations/vm-connect/ssh.md).

   {% note alert %}

   IP-адрес и имя хоста (FQDN) для подключения к ВМ назначается ей при создании. Если вы выбрали вариант **Без адреса** в поле **Публичный адрес**, вы не сможете обращаться к ВМ из интернета.

   {% endnote %}

1. Нажмите кнопку **Создать ВМ**.

   Создание ВМ может занять несколько минут. Когда ВМ перейдет в статус `RUNNING`, вы можете перейти к настройке.

## Проверьте работу веб-сервера по внешнему адресу ВМ{#test-webserver-ext-address}
Чтобы проверить работу сайта, введите в браузере его IP-адрес:
* `http://<публичный IP-адрес виртуальной машины>`.

При правильной настройке **LAMP** вы должны увидеть вывод страницы **Apache** по умолчанию. 
Индикатор безопасности (замочек) в строке браузера будет указывать, что соединение не является безопасным.

## Настройте виртуальный хост для вашего домена{#configure-virthost-http}

Чтобы иметь возможность c помощью `Certbot` создать сертификат **SSL**, необходимо в директиве `ServerName` файла конфигурации **Apache** указать доменное имя. 

1. Сохраните резервную копию конфигурационного файла по умолчанию:
```bash
$ sudo cp /etc/apache2/sites-available/000-default.conf /etc/apache2/sites-available/000-default.conf.bak
```
2. Измените строки `ServerName` и `ServerAdmin` конфигурационного файла виртуального хоста:
```bash
$ sudo nano /etc/apache2/sites-available/000-default.conf

```
{% note info %}

Имя домена `example.com` используется для примера. Во всех командах и конфигурационных файлах здесь и далее вместо строки `example.com` подставляйте свой домен.

{% endnote %}

```bash
<VirtualHost *:80>
ServerName example.com
ServerAdmin webmaster@example.com
# другие директивы виртуального хоста
</VirtualHost>
```
3. Сохраните изменения и закройте файл. После этого проверьте синтаксис конфигурации.
```bash
sudo apache2ctl configtest
```
Если команда сообщила об ошибке, снова откройте файл и исправьте строку. После этого повторите проверку.

4. Если ошибок в конфигурации нет, перезагрузите конфигурацию веб-сервера.
```bash
sudo systemctl reload apache2
```
Теперь `Certbot` сможет найти ваше имя домена в блоке `VirtualHost`.

## Настройте сетевой экран ВМ {#configure-ufw}.

Для защиты виртуальной машины нужно включить сетевой экран **UFW** и настроить его для поддержки входящих соединений по протоколам **SSH** (22), **HTTP**(80) и **HTTPS**(443).

Во время установки **Apache** и **OpenSSH** регистрируют в **UFW** несколько профилей. 

Убедитесь, что профили приложений установлены:
```bash
sudo ufw app list
```
На вновь созданной ВМ вы должны увидеть такой вывод:
```bash
Available applications:
  Apache
  Apache Full
  Apache Secure
  OpenSSH
```
Выведите список правил **UFW**:
```bash
sudo ufw show added
```
На вновь установленной LAMP вывод добавленных правил UFM должен быть пустым.

{% note tip %}

Добавленные правила UFM выводятся даже при незапущенном (неактивном) сервисе.

{% endnote %}

Добавьте в **UFW** необходимые правила:
```bash
sudo ufw allow ssh
sudo ufw allow 'Apache Full'
```
{% note info %}

Использование профиля `'Apache Full'` в команде `ufw allow` эквивалентно двум правилам для разрешения доступа по портам `80` и `443`.

{% endnote %}

{% note alert %}

Если до активации **UFW** вы не разрешите правило для **SSH**, то после активации **UFW** вы потеряете связь с ВМ.

{% endnote %}

Включите **UFW**:
```bash
sudo ufw enable
```
Итоговые настройки **UFW** должны быть такими:
```bash
sudo ufw status
Status: active
To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
Apache Full                ALLOW       Anywhere
22/tcp (v6)                ALLOW       Anywhere (v6)
Apache Full (v6)           ALLOW       Anywhere (v6)
``` 

## Настройте DNS {#configure-dns}
Чтобы привязать сайт к домену, настройте **DNS** у вашего регистратора следующим образом:
-   A-запись: поддомен `@`, в качестве адреса используйте публичный IP-адрес виртуальной машины.
-   CNAME-запись: поддомен `www`, в качестве канонического имени используйте домен с точкой на конце, например: `example.com.`

{% note info %}

Вместо записи `CNAME` может быть настроена вторая А-запись, где в качестве поддомена укажите `www`, а в качестве адреса используйте публичный IP-адрес виртуальной машины.  

{% endnote %}

Проверьте разрешение имени в IP-адрес сайта: 
```bash
$ nslookup www.example.com <сервер имен регистратора домена>
```

## Проверьте работу сайта по доменному имени {#test-webserver-cname}

Чтобы проверить работу сайта по доменному имени, введите в браузере: `http://www.example.com`.

{% note info %}

Для доступа к веб-сайту с тем же именем домена по новому адресу предварительно очистите кэш вашего браузера или запустите другой браузер.

{% endnote %}

При правильной настройке записей `А` и `CMANE` вы должны увидеть вывод страницы по умолчанию `index.html` сервера **Apache**.

Индикатор безопасности (замочек) в строке браузера будет указывать, что соединение не является безопасным.


## Создайте **SSL** cертификат Let’s Encrypt для **Apache** {#create-ssl-le-http-apache}

### Предварительно установите ACME-клиент `Certbot` от [Electronic Frontier Foundation](https://certbot.eff.org/).

1. Установите `Certbot` из **SNAP**:
```bash
sudo apt install snapd
sudo snap install --classic certbot
```
{% note info %}

Если ранее на эту ВМ через диспетчер пакетов `apt` были установлены пакеты `Certbot`, предварительно удалите их.
```bash
sudo apt-get remove certbot
```
{% endnote %}

2. Проверьте, что `Certbot` может быть запущена:
```bash
sudo ln -s /snap/bin/certbot /usr/bin/certbot
```

### Получите SSL-сертификат от удостоверяющего центра **Let’s Encrypt**.

Чтобы получить сертификаты **SSL** для веб-сайта на платформе **LAMP** с помощью клиента `Certbot` нужно использовать плагин `--apache`.

{% note info %}

Клиент `Certbot` умеет создавать сертификаты, устанавливать их и настраивать **Apache** автоматически, но в этом режиме не выполняется ряд важных настроек безопасности. Будем использовать `Certbot`только для создания сертификатов, а их установку и необходимые настройки **Apache** выполним вручную. 

{% endnote %}

1. Запустите `Certbot` с субкомандой `certonly`, плагином `-–apache` и флагом `–d`, после которого укажите имя своего домена. 

```bash
$ sudo certbot certonly --apache -d example.com
```

{% note info %}

Допускается добавление в один сертификат домена до ста субдоменов. Добавить новый субдомен или удалить ранее включенный субдомен в сертификат возможно в любое время без запуска процедуры выпуска нового сертификата. Как это сделать, описано в [документации](https://eff-certbot.readthedocs.io/en/stable/using.html#changing-a-certificate-s-domains).

{% endnote %}

2. Введите адрес электронной почты, который будет использоваться удостоверяющим центром **Let's Encrypt** для направления уведомлений по выпускаемому сертификату, примите предлагаемые условия обслуживания, разрешите публично использовать ваш `E-mail` для целей улучшения программного обеспечения. 

{% note info %}

После получения от вас необходимых данных клиент `Certbot` связывается с сервером **Let’s Encrypt** и выполняет с помощью **Apache** проверку, которая должна подтвердить, что вы контролируете указанный домен. 

{% endnote %}

{% cut "Вывод в консоль при создании сертификата" %}

В процессе выполнения вы должны увидеть примерно такой вывод:
```
Obtaining a new certificate
Performing the following challenges:
http-01 challenge for example.com
Waiting for verification...
Cleaning up challenges
```
```
IMPORTANT NOTES:
- Congratulations! Your certificate and chain have been saved at:
/etc/letsencrypt/live/example.com/fullchain.pem
Your key file has been saved at:
/etc/letsencrypt/live/example.com/privkey.pem
Your cert will expire on {DATE}. To obtain a new or tweaked
version of this certificate in the future, simply run certbot again with the "certonly" option. To non-interactively renew *all* of your certificates, run "certbot renew" 
- Your account credentials have been saved in your Certbot
configuration directory at /etc/letsencrypt. You should make a secure backup of this folder now. This configuration directory will also contain certificates and private keys obtained by Certbot so making regular backups of this folder is ideal.
```
{% endcut %}

3. Убедитесь, что созданные сертификаты и ключ безопасности сохранены в каталоге /etc/letsencrypt/live/example.com.

{% note info %}

Назначение каждого сертификата:
-   `cert.pem` - файл сертификата, его нужно прописать в параметре `SSLCertificateFile`;
-   `chain.pem` - файл цепочки сертификата, обычно прописывается в параметре `SSLCertificateChainFile`;
-   `privkey.pem` - ключ безопасности, должен быть прописан в `SSLCertificateKeyFile`;
-   `fullchain.pem` - в нём объединено содержимое `cert.pem` и `chain.pem`, можно использовать вместо этих файлов.

{% endnote %}

{% note tip %}

Начиная с версии **Apache** 2.4.8 используйте `fullchain.pem` в качестве сертификата для директивы `SSLCertificateFile`. Использование `cert.pem` для этой цели не рекомендовано.

{% endnote %}

## Настройка доступа к веб-сайту по протоколу **HTTPS** {#configure-access-https-apache}.
  
Чтобы обеспечить доступ к веб-сайту по протоколу **HTTPS** нужно настроить виртуальный хост, который слушает порт 443.  

1. Создайте резервную копию файла конфигурации `default-ssl.conf`:
```bash
$ sudo cp /etc/apache2/sites-available/default-ssl.conf /etc/apache2/sites-available/default-ssl.conf.bak
```

2. Измените файл `/etc/apache2/sites-available/default-ssl.conf` так, чтобы он содержал следующие строки:
```bash
<IfModule mod_ssl.c>
   <VirtualHost *:443>
      ServerName example.com
      ServerAdmin webmaster@example.com
      DocumentRoot /var/www/html
      ErrorLog ${APACHE_LOG_DIR}/error.log
      CustomLog ${APACHE_LOG_DIR}/access.log combined

      SSLEngine on
      SSLCertificateFile /etc/letsencrypt/live/example.com/fullchain.pem
      SSLCertificateKeyFile /etc/letsencrypt/live/example.com/privkey.pem

      Protocols h2 http/1.1
      
        <FilesMatch "\.(cgi|shtml|phtml|php)$">
            SSLOptions +StdEnvVars
        </FilesMatch>
    
        <Directory /usr/lib/cgi-bin>
            SSLOptions +StdEnvVars
        </Directory>
        
   </VirtualHost>
</IfModule>
```
3. Включите модуль для поддержки **SSL**:
```bash
sudo a2enmod ssl
```

4. Включите модуль **HTTP / 2**:
```bash
sudo a2enmod http2
```
**HTTPS** позволяет использовать протокол **HTTP / 2**, что значительно повышает производительность сайта и повышает уровень безопасности.

5. Активируйте виртуальный хост с помощью команды `a2ensite`:
```bash
sudo a2ensite default-ssl
```

6. Чтобы перезапустить **Apache** введите следующую команду:
```bash
$  sudo systemctl restart apache2
```

7. Загрузите через браузер ваш сайт по безопасному протоколу: `https://www.example.com` и обратите внимание на индикатор безопасности в адресной строке браузере. Индикатор должен указывать, что сайт защищен. Как правило, для этого используется зеленый замочек в адресной строке браузера. При наведении указателя манипулятора на замочек вы должны увидеть выпадающее сообщение об используемом вашим сайтом сертификате.

## Настройте автоматическое обновление сертификата {#configure-le-renew}

Полученные от **Lets Encrypt** сертификаты действительны только на протяжении 90 дней. Клиент `Certbot` поддерживает команду `renew`, которая позволяет проверить установленные сертификаты и обновить их, если до истечения срока осталось меньше 30 дней.

1. Чтобы однократно запустить процесс обновления для всех настроенных доменов выполните:

```bash
 sudo certbot renew
```
{% note info %}

Если сертификат был выдан недавно, то команда проверит его дату истечения и выдаст сообщение, что продление не требуется. Если вы создали сертификат для нескольких доменов, то в выводе будет показан только основной домен. Но обновление будет актуально для всех.

{% endnote %}

2. Чтобы обновление выполнялось автоматически, необходимо добавить вызов утилиты `certbot` с опцией `renew` в планировщик задач `cron` вашей ВМ.

    1. Откройте файл планировщика задач для внесения изменений:
    ```bash
   crontab -e
   ```
    2. В открывшемся файле добавьте строку и сохраните изменения:

   ```bash
   30 2 * * 1 /usr/bin/certbot renew >> /var/log/le-renewal.log
   ```
 
   {% note info %}

   Команда обновления будет запускаться каждый понедельник в 2:30 утра. Сведения о результате выполнения будут сохраняться в файл /var/log/le-renewal.log.

   {% endnote %}
   
## Настройте расширенные настройки безопасности **Apache** {#configure-advanced-security-apache}.
Чтобы достичь уровня криптографической безопасности сайта по версии `SSLLabs.com` равного `A+`, нужно выполнить ряд настроек веб-сервера Apache, которые описаны в [рекомендации](https://wiki.mozilla.org/Security/Server_Side_TLS). 

1. Для генерации рекомендованных настроек используйте **SSL Configuration Generator** от [Mozilla](https://ssl-config.mozilla.org). 

Чтобы получить рекомендованные настройки введите исходные данные: 
* В левой части данного конфигуратора в колонке **Server Software** выберите используемую вами платформу **Apache**. 
* В центральной части конфигуратора выберите криптографический набор: **Intermediate**.
* В правой части конфигуратора **Environment** (Системное окружение) впишите номер используемой на вашей ВМ версии **Apache** и **OpenSSL**, установите другие требования (**Miscellaneous**) к набору: строгая безопасность передачи `HTTP Strict Transport Security` и сшивание OCSP (`OCSP Stapling`). 

{% note info %}

Часть рекомендованных **Mozilla** настроек, которая относится к активации `EngineSSL` и указания на место расположения созданного **Let's Encrypt** сертификата и ключа безопасности, вы уже выполнили ранее. 

{% endnote %}

2. Создайте файл `/etc/apache2/conf-available/ssl-params.conf` и включите в него директивы, которые соответствуют остальным рекомендациям, полученным от **Mozilla**:

```bash
SSLProtocol             all -SSLv3 -TLSv1 -TLSv1.1
SSLCipherSuite          ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
SSLHonorCipherOrder     off
SSLSessionTickets       off

SSLUseStapling On
SSLStaplingCache "shmcb:logs/ssl_stapling(32768)"
```
{% note info %}

Установленный по умолчанию в Ubuntu 18.04.LTS пакет OpenSSL версии 1.1.1 (11 Sep 2018) поддерживает TLSv1.3. 

{% endnote %}

3. Чтобы измененные **SSL**-настройки были учтены, активируйте `ssl-params.conf`:
```bash
sudo a2enconf ssl-params.conf
```  
4. Чтобы изменения вступили в силу, перезагрузите конфигурацию **Apache**:
```bash
sudo systemctl reload apache2
```
5. Директиву для выполнения рекомендаций по настройке `HSTS` добавьте в файл `/etc/apache2/sites-available/default-ssl.conf` отдельной строкой в конце блока:
```bash
<VirtualHost *:443>
# другие директивы
Header always set Strict-Transport-Security "max-age=63072000"
</VirtualHost>
```
6. Включите модуль **mod_headers**:
```bash
sudo a2enmod headers
```
7. Перезапустите **Apache**:
```bash
$  sudo systemctl restart apache2
```

8. Проверьте настройку сервера с помощью [SSL Labs Server Test](https://www.ssllabs.com). Убедитесь, что рейтинг (Overall Rating) в `SSL Report_Summary` вашего сайта соответствует уровню `A+`.

## Настройте переадресацию (редирект) запросов по HTTP {#configure-redirect-https-apache}. 
После завершения тестирования доступа к сайту по протоколу **HTTPS** нужно настроить перенаправление (редирект) на **HTTPS** при обращении браузера по протоколу **HTTP**. 

1. Добавьте строку в файле конфигурации (`/etc/apache2/sites-available/000-example.conf`) виртуального хоста, слушающего 80 порт: 
```bash
<VirtualHost *:80>
ServerName example.com
ServerAdmin webmaster@example.com
DocumentRoot /var/www/html

RewriteEngine On
RewriteCond %{REQUEST_URI} !^/\.well\-known/acme\-challenge/
RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L] 

ErrorLog ${APACHE_LOG_DIR}/error.log
CustomLog ${APACHE_LOG_DIR}/access.log combined
</VirtualHost>
```
Активируйте модуль `mod_rewrite`:
```bash
sudo a2enmod rewrite
```
Введите следующую команду, чтобы перезапустить **Apache**:
```bash
$  sudo systemctl restart apache2
```

2. Введите в строке браузера `http://example.com`, а затем `http://www.example.com`, и убедитесь, что в обоих случаях вы были сразу же переадресованы на `https://example.com`. Повторите такие действия для других страниц вашего сайта с префиксом `http://`.

{% note warning %}

Если редирект настроен правильно, то ни одна из страниц вашего сайта не должна открываться по адресу с префиксом `http://`.

{% endnote %}

Проверьте, что в заголовках при подстановке в [HTTP HEADER CHECKER](https://tools.keycdn.com/curl) значений `http://example.com`, а затем `http://www.example.com`, вы получаете вывод с кодом 301 (редирект), который содержит строку `Location: https://example.ru/`.

Теперь ваш веб-сервер настроен для безопасного доступа. Вы можете начать перенос рабочих данных из сайта-приемника.

## Установите дополнительные пакеты php для Wordpress {#install-add-php-for-wordpress}

При настройке нашего стека **LAMP** был установлен только минимальный набор расширений, чтобы реализовать взаимодействие **PHP** с **MySQL**. Для **Wordpress** нужно установить дополнительные расширения **PHP**.

Установите некоторые из самых популярных расширений **PHP**, которые будет использовать **Wordpress**:

```bash
$   sudo apt update
$   sudo apt install php-curl php-gd php-mbstring php-xml php-xmlrpc php-soap php-intl php-zip
``` 

{% note alert %}

Каждый плагин **Wordpress** имеет собственный набор требований. Для поддержки некоторых из них может потребоваться установка дополнительных пакетов **PHP**. Ознакомьтесь с документацией каждого плагина для получения информации о требованиях к **PHP**. Если такие пакеты **PHP** доступны, их можно установить с помощью `apt`, как показано выше.

{% endnote %}

## Подготовьте резервную копию базы данных Wordpress{#create-dump-mysql-migration-wordpress}

Чтобы перенести учетные записи пользователей и другие данные **Wordpress**, которые хранятся в базе данных, нужно создать резервную копию базы данных сайта-источника. 

{% note info %}

Перед тем, как создавать резервные копии файлов и базы данных веб-сайта **Wordpress**, деинсталируйте все неиспользуемые плагины, деактивируйте все используемые плагины и включите для CMS **Wordpress** режим технического обслуживания.

{% endnote %}

Для создания резервной копии базы данных используйте возможности предоставляемые панелями управления хостингом (**Parallels PLESK**, **DirectAdmin**, **ISP Manager Lite**, **cPanel** и другие). 

Например, в панели **PLESK** используйте раздел **Дополнительные услуги** – **Резервные копии**, где выберите **Сформировать архив** для **База данных**.
После завершения создания резервной копии базы данных на хостинге загрузите архивный файл на свой компьютер.   

{% note info %}

Альтернативно, для экспорта базы данных **Wordpress** используйте утилиту `PhpMyAdmin`, которая доступна на большей части хостингов. Имя базы данных **Wordpress** сайта-источника возьмите из файла конфигурации wp-config.php, который размещен в корневом каталоге сайта-источника.

{% endnote %}

## Подготовьте архив всех файлов **Wordpress** {#create-arсhive-all-files-migration-wordpress}.
Чтобы перенести без ошибок все файлы Wordpress, рекомендуется создать сжатый архив сайта-источника.

Используйте возможности предоставляемые панелями управления хостингом для создания и сохранения резервной копии всех файлов сайта-источника на вашем компьютере. 

Например, в панели **PLESK** используйте раздел **Дополнительные услуги** – **Резервные копии**, где выберите **Сформировать архив** для **Файлы сайта**. 

{% note info %}

Альтернативно, на каждом хостинге имеется файловый менеджер, с помощью которого вы можете создать архив `zip` (или `gzip`) всех файлов вашего сайта-источника. В файловом менеджере перед выбором файлов для добавления в архив включите режим видимости скрытых файлов.

{% endnote %}

## Загрузите резервную копию базы данных Wordpress с компьютера в домашний каталог {#upload-dump-from-pc-to-home-catalog}.

Загрузите со своего компьютера резервную копию базы данных в домашний каталог пользователя ВМ. Если резервная копия базы данных выгружалась из сайта-источника в архиве, то распакуйте архив в этой же директории. 


## Загрузите файлы Wordpress с компьютера в корневой каталог {#upload-files-from-pc-to-documentroot}.

Созданный архив файлов Wordpress нужно распаковать в корневой каталог веб-сервера.

1. Разрешите текущему пользователю доступ в корневой каталог сайта-приемника:  

* В блоке **Сеть** на странице ВМ в [консоли управления]({{ link-console-main }}) найдите публичный IP-адрес ВМ.
* [Подключитесь](../../compute/operations/vm-connect/ssh.md) к ВМ по протоколу SSH.
* Выдайте права на запись для вашего пользователя на директорию `/var/www/html`: 

```bash
  $ sudo chown -R "$USER":www-data /var/www/html
```

2. Загрузите со своего компьютера на ВМ архив файлов сайта-источника с помощью консольной утилиты [SCP](https://ru.wikipedia.org/wiki/SCP) для **Linux** (**MacOS**) или с помощью графической утилиты [WinSCP](https://ru.wikipedia.org/wiki/WinSCP) для **Windows**.

3. Переместите архив файлов сайта-источника в корневой каталог сайта-приемника. Распакуйте архив в этом же каталоге. 

## Настройте права доступа к каталогам и файлам сайта-приемника{#configure-access-rights-apache}

После завершения переноса файлов сайта-источника нужно установить владельца каталога и права доступа для каталогов сайта-приёмника. 

1. [Подключитесь](../../compute/operations/vm-connect/ssh.md) к ВМ используя публичный адрес по протоколу **SSH**.
2. Установите для пользователя `www-data` группы `www-data` права на директорию `/var/www`: 

   ```bash
   $ sudo chown -R www-data:www-data /var/www
   ```
3. Установите корректные разрешения для каталогов и файлов:
   ```bash
   $ sudo find /var/www/ -type d -exec chmod 755 {} \;
   $ sudo find /var/www/ -type f -exec chmod 644 {} \;
   ```

{% note alert %}

Некоторым плагинам и процедурам Wordpress могут потребоваться дополнительные настройки.

{% endnote %}

4. Удалите в корневом каталоге веб-сайта файл `index.html`, который вы использовали ранее для проверки работы стека **LAMP**:

```bash
sudo rm /var/www/html/index.html
```

## Восстановите базу данных Wordpress из резервной копии.{#recovery-database-wordpress-from-dump}.

Чтобы восстановить базу данных **Wordpress** нужно с заданными настройками создать пустую базу и импортировать в неё резервную копию базы данных сайта-источника. Затем нужно импортировать резервную копию базы данных сайта-источника во вновь созданную базу данных сайта-приемника. Для того, чтобы приложение **Wordpress** имело возможность записывать данные в эту базу данных, нужно создать пользователя c полномочиями для доступа к этой базе данных.

Перечисленное выше возможно сделать различными способами, в том числе, с помощью утилиты **PhpMyAdmin** с графическим интерфейсом или с помощью командной строки оболочки **MySQL**. 

{% note info %}.

Версия пакета **PhpMyAdmin** в основном репозитории **Ubuntu 18.04 LTS** от **Yandex.Cloud** сильно устарела и при её установке возникают ошибки и предупреждения. После установки требуется вручную обновить утилиту до актуальной версии. 

{% endnote %}.

Наиболее просто и безопасно выполнить указанные выше действия с помощью консоли **MySQL**. 

{% note info %}

Для версии сборки **LAMP** на базе **Ubuntu 18.04 LTS** по умолчанию для **MySQL** включен режим парольной аутентификации (`mysql_native_password`). 

{% endnote %}

Используйте пароль пользователя `root` для **MySQL**, который был создан во время установки **LAMP** на вашей ВМ. 

Этот пароль можно вывести на экран командой:
```bash
$ sudo cat root/default-passwords.txt  
```
1. Создайте для **Wordpress** базу данных:
```bash
$ sudo mysql -u root -p 
>CREATE DATABASE db_name CHARACTER SET utf8 COLLATE utf8_general_ci;
>quit;
```
Имя создаваемой базы данных (`db_name`) укажите такое же, как в строке `WP_DB_NAME` перенесенного файла конфигурации `/var/www/html/wp-config.php`: 
```bash
...
/** The name of the database*/
define( 'DB_NAME', 'WP_DB_NAME' );
... 
```
2. Импортируйте базу данных сайта-источника **Wordpress** во вновь созданную базу данных:

```bash
$ mysql -u root -p -f db_name < wp_db_name_dump.sql
```

3. Создайте пользователя `db_user` базы данных `db_name`. Предоставьте созданному пользователю все права на восстановленную базу данных. Для выхода из оболочки (shell) mysql наберите `quit` и нажмите `Enter`.

```bash
$ sudo mysql -u root -p
>GRANT ALL ON db_name.* to db_user@localhost IDENTIFIED BY 'db_password';
>FLUSH PRIVILEGES;
>quit
```
Имя пользователя `db_user` и пароль `db_password` укажите такими же, как в строке `WP_DB_USER` перенесенного файла конфигурации /var/www/html/wp-config.php.
```bash
/** MySQL database username */
define( 'DB_USER', 'WP_DB_USER' );
/** MySQL database password */
define( 'DB_PASSWORD', 'WP_DB_PASSWORD' );
... 
```
{% note info %}

Если нужно сменить пароль пользователя **Wordpress**, то в инструкции `GRANT` укажите новый пароль db_password для создаваемого пользователя базы данных Wordpress и сразу же отредактируйте поле `WP_DB_PASSWORD` в файле конфигурации `var/www/html/wp-config.php`.

{% endnote %}

## Настройте **Wordpress** для работы в защищенном режиме{#configure-wordpress-https}.

Для обеспечения нормальной работы **Wordpress** в защищенном режиме нужно: для правильного формирования относительных ссылок изменить адрес сайта и его главной страницы с префикса `http://` на префикс `https://`, отключить возможность доступа к административной панели **Wordpress** по незащищенному протоколу **HTTP**, настроить в базе данных абсолютные ссылки с префиксом `https://` . После завершения работ с восстановленной копией базы данных нужно удалить резервную копию баз данных. Далее, для восстановления функциональности сайта, нужно отключить режим технического обслуживания **Wordpress** и активировать все ранее деактивированные плагины **Wordpress**.

1. Измените адрес сайта **Wordpress** и его главной страницы. Это можно сделать путём изменения файла `wp-config.php`, изменив в нем с помощью любого редактора строки:

```bash
define('WP_HOME', 'https://example.com');
define('WP_SITEURL', 'https://example.com');
```
2. Чтобы гарантировать, что доступ к админ панели **Wordpress** возможен только с использованием протокола **HTTPS**, в этот же файл добавьте следующий код:
```bash
define ('FORCE_SSL_ADMIN', true);
```
{% note info %}

Размещать эту директиву в конфигурационном файле `wp-config.php` следует перед тем, как подключается файл `wp-settings.php`.

{% endnote %}

Для случая, если ваш сайт **Wordpress** расположен за обратным прокси-сервером, при использовании предыдущей директивы, обязательно добавьте следующий код:
```bash
if (strpos ($ _ SERVER ['HTTP_X_FORWARDED_PROTO'], 'https')! == false) {
    $ _SERVER [ 'HTTPS'] = 'on';
}
```
3.	Для проверки отсутствия в базе данных абсолютных **HTTP**-ссылок убедитесь, что все страницы вашего сайта открываются по защищенному протоколу без ошибок.
 
Если индикатор безопасности на одной из страниц сайта указывает на смешанный режим (`mixed mode`) проверьте, что записи базы данных **Wordpress** не содержат абсолютных ссылок, которые начинаются с префикса `http://`. Если такие ссылки имеются, то замените их на префикс `https://`. 

Для замены префиксов в абсолютных ссылках, в том числе сериализованных, используйте утилиту командной строки Wordpress [WP-CLI](https://wpcli.ru/) и команду `search-replace`. 

### Установите WP-CLI на сайте-приемнике:

1. Скачайте утилиту WP-CLI:
```bash
sudo curl -O https://raw.githubusercontent.com/wp-cli/builds/gh-pages/phar/wp-cli.phar
```
2. Разрешите запуск WP-CLI из любого каталога:
```bash
$ sudo chmod +x wp-cli.phar
$ sudo mv wp-cli.phar /usr/local/bin/wp
```
3. Проверьте правильность установки командой:
```bash
$ wp --info
```
### Подготовьте сайт для выполнения замен:
1. Перейдите в корневой каталог сайта-приемника:
```bash
$ cd /var/www/html/
```
2. Перед началом небезопасных работ убедитесь, что ваш сайт находится в режиме технического обслуживания (`Maintenance`):
   
```bash
$ wp maintenance-mode status
# Maintenance mode is active.
```

### Выполните замену ссылок:
1. Протестируйте замену префиксов в ссылках c опцией `--dry-run`:
```bash
$ wp search-replace 'http://example.com' 'https:// example.com' --precise --skip-columns=guid,user_email --dry-run
```
{% note warning %}

Никакие изменения в базу данных **Wordpress** не будут записаны.

{% endnote %}

2. Если предыдущая команда завершится без ошибок, то выполните данную команду повторно без опции `–dry-run`:
```bash
$ wp search-replace 'http://example.com' 'https:// example.com' --precise --skip-columns=guid,user_email
```
{% note warning %}

Без опции `--dry-run` все изменения будут записаны в базу данных **Wordpress**.

{% endnote %}

{% note tip %}

Для большинства случаев достаточно использовать две опции: 
* `--precise` – для принудительного использования режима **PHP** (вместо **SQL**), который обеспечит поиск и замену сериализованных данных;
* `--skip-columns=guid,user_email` - для предотвращения нежелательного изменения данных.

{% endnote %}

{% note info %}

Опции для команды `search-replace` утилиты `WP-CLI` подробно описаны в этой [инструкции](https://wpengine.com/support/find-replace/). 

{% endnote %}

4. После успешного завершения перевода сайта на **HTTPS** удалите резервную копию базы данных.

5. Отключите средствами **WP-CLI** режим технического обслуживания сайта:

```bash
$ wp maintenance-mode deactivate
# Disabling Maintenance mode...
# Success: Deactivated Maintenance mode.
``` 

6.	Активируйте все установленные плагины **Wordpress**, которые были деактивированы перед началом переноса сайта:

```bash
$ wp plugin activate --all
``` 

7. Убедитесь, что работа сайта с включенными плагинами не нарушилась. Если появились ошибки, установите плагин вызывающий ошибки и отключите его. Свяжитесь с разработчиками плагина для устранения ошибки. 

## Настройте веб-сайт **Wordpress** для правильной индексации по **HTTPS**{#configure-wordpress-sitemap-robot-https}

После настройки **SSL**-сертификата и проверки корректности его работы нужно обновить файлы сайта (`sitemap.xml`, `robot.txt`), которые влияют на процесс его сканирования поисковыми роботами, а также на индексацию страниц.

1. Смена протокола доступа с **HTTP** на **HTTPS** ведет к соответствующим изменениям в **URL** страниц сайта. Следовательно, нужно обновить файл `sitemap.xml` по протоколу **HTTPS** и поместить актуальную версию карты сайта в корневой каталог вашего сайта.

Если карта сайта была актуальной на момент перехода с **HTTP** на **HTTPS**, то вручную замените все ссылки в редакторе `notepad++`.

Если карта сайта на момент переноса была неактуальной или отсутствовала, сформируйте её с помощью одного из онлайн-сервисов, например, [MySitemapGenerator](https://mysitemapgenerator.com/) или [HTML Web](https://htmlweb.ru/service/).

Замените новым файлом карту сайта в корневом каталоге сайта, который был переведён на **HTTPS**.

2. Измените в файле `robot.txt` адрес карты сайта и вашего сайта с `http://` на `https://`:
```
...bash
Sitemap: https://example.com/sitemap.xml
Host: https://example.com/
```
{% note info %}

Директива `Host` больше не поддерживается сервисами **Яндекс**.

{% endnote %}

## Выполните переезд сайта с **HTTP** на **HTTPS** в **Google Search Console**{#migration-hhtp-https-google}.
Чтобы сообщить **Google Search Console** об изменении адреса вашего сайта и ускорить процесс исключения из индекса страниц с `http://` нужно зарегистрировать новый ресурс `https://` и загрузить обновленный файл `sitemap.xml`.

### Добавьте в **Google Search Console** имя сайта с префиксом `https://`: 
1. Зайдите в Google Search Console.
1. Выберите в верхнем меню **Ресурс** - **Добавить ресурс**.
1. В правой части формы **Ресурс с префиксом в URL** введите адрес своего сайта с префиксом `https` и нажмите **Продолжить**. Право собственности будет подтверждено автоматически. 
1. Проверьте, что в списке ресурсов появился ваш сайт с префиксом `https`.

### Добавьте карту сайта в Google Search Console:
1. Выберите свой https-сайт из выпадающего списка **Ресурс**.
1. Зайдите в раздел **Файлы** - **Sitemap**.
1. Добавьте ссылку на карту сайта с префиксом `https://`.
1. Нажмите кнопку **Отправить**. 
1. Ожидайте когда статус **Файлы Sitemap на проверке** изменится на `Успешно`.

### Наблюдайте процесс исключения старых и добавления новых страниц. 
1. Выберите в меню слева **Покрытие**.
1. Нажмите блок **Исключено**
1. Пройдите по ссылке **Страница с переадресацией**.
1. Просмотрите список исключенных страниц. 

## Выполните переезд сайта с **HTTP** на **HTTPS** в **Яндекс.Вебмастер**{#migration-hhtp-https-yandex}.

Чтобы сообщить **Яндекс.Вебмастер** об изменении адреса вашего сайта и ускорить процесс исключения из индекса страниц с `http://` нужно зарегистрировать новый ресурс `https://` и загрузить обновленный файл `sitemap.xml`. 

Полный перечень действий, которые требуется совершить при переходе на **HTTPS**, описаны в Шаге 2 раздела **Переход сайта на HTTPS** [Яндекс.Справка](https://yandex.ru/support/webmaster/yandex-indexing/https-migration.html#https-migration__link). 

{% note alert %}

Все указанные ниже действия доступны после регистрации в сервисе [Яндекс.Вебмастер](https://webmaster.yandex.ru/welcome/).

{% endnote %}
 
### Добавьте `https` сайт:
1. Перейдите в **Яндекс.Вебмастер** и рядом с **Выбрать сайт** нажмите **+**
2. В строке **Адрес сайта** введите новый с префиксом `https`: 
3. Нажмите кнопку **Добавить**.

### Для ускорения индексирования используйте инструмент **"Переезд сайта"**:
1. Перейдите в **Яндекс.Вебмастер** и выберите сайт, с которого хотите переехать.
2. На странице **Индексирование** → **Переезд сайта** включите опцию **Добавить HTTPS**.
3. Нажмите кнопку **Сохранить**.

### Добавьте карту `Sitemap` в **Яндекс.Вебмастер**:
1. Перейдите в **Яндекс.Вебмастер** и выберите сайт, на который хотите переехать.
2. На странице **Индексирование** → **Файлы Sitemap** впишите новый адрес карты `https://example.com/sitemap.xml`.
3. Нажмите кнопку **Добавить**.

### Проверьте, что сайт с протоколом `https` является главным зеркалом:
1. Перейдите в **Яндекс.Вебмастер** и выберите **Все сайты**.
2. Убедитесь, что в строке с `https://example.com` имеется символ `X`, который указывает на главное зеркало.  

## Как удалить созданные ресурсы {#clear-out}

Чтобы перестать платить за развернутый сервер, достаточно [удалить](../../compute/operations/vm-control/vm-delete.md) ВМ `lamp-vm`.

Если вы зарезервировали статический публичный IP-адрес специально для этой ВМ:

1. Откройте сервис **{{ vpc-name }}** в вашем каталоге.
1. Перейдите на вкладку **IP-адреса**.
1. Найдите нужный адрес, нажмите значок ![ellipsis](../../_assets/options.svg) и выберите пункт **Удалить**.

